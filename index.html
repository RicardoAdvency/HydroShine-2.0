<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Comisiones</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #ffffff;
  color: #0b1b3a;
  line-height: 1.6;
}

.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

header {
  text-align: center;
  padding: 30px 0 20px;
  border-bottom: 3px solid #F59E0B;
  margin-bottom: 40px;
}

.logo-container {
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo {
  max-width: 250px;
  max-height: 80px;
  display: none;
}

.logo.loaded {
  display: block;
}

.gate-screen, .calculator-screen {
  display: none;
}

.gate-screen.active, .calculator-screen.active {
  display: block;
}

.card {
  background: #ffffff;
  border: 2px solid #e6ecf3;
  border-radius: 8px;
  padding: 40px;
  box-shadow: 0 2px 8px rgba(11, 27, 58, 0.08);
}

.card-title {
  font-size: 24px;
  font-weight: 700;
  color: #0b1b3a;
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding-bottom: 10px;
  border-bottom: 2px solid #F59E0B;
}

.form-group {
  margin-bottom: 25px;
}

label {
  display: block;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #0b1b3a;
  margin-bottom: 8px;
}

input, select {
  width: 100%;
  padding: 12px 16px;
  font-size: 16px;
  border: 2px solid #e6ecf3;
  border-radius: 6px;
  background: #ffffff;
  color: #0b1b3a;
  transition: all 0.3s ease;
}

input:focus, select:focus {
  outline: none;
  border-color: #F59E0B;
}

button {
  width: 100%;
  padding: 14px 24px;
  font-size: 16px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #ffffff;
  background: #0b1b3a;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(11, 27, 58, 0.2);
}

button:hover:not(:disabled) {
  background: #162d5a;
  box-shadow: 0 4px 12px rgba(11, 27, 58, 0.3);
  transform: translateY(-1px);
}

button:disabled {
  background: #e6ecf3;
  color: #a0a0a0;
  cursor: not-allowed;
  box-shadow: none;
}

.results {
  margin-top: 30px;
  padding-top: 30px;
  border-top: 2px solid #e6ecf3;
  display: none;
}

.results.visible {
  display: block;
}

.result-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 0;
  border-bottom: 1px solid #e6ecf3;
}

.result-row:last-child {
  border-bottom: none;
}

.result-label {
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  color: #0b1b3a;
}

.result-value {
  font-size: 20px;
  font-weight: 700;
  color: #0b1b3a;
}

.commission-highlight {
  background: #16a34a;
  color: #ffffff;
  padding: 20px;
  border-radius: 6px;
  margin-top: 20px;
}

.commission-highlight .result-label {
  color: #ffffff;
  font-size: 16px;
}

.commission-highlight .result-value {
  color: #ffffff;
  font-size: 32px;
}

.status-message {
  padding: 12px 16px;
  border-radius: 6px;
  margin-bottom: 20px;
  font-size: 14px;
  display: none;
}

.status-message.visible {
  display: block;
}

.status-message.error {
  background: #fef2f2;
  color: #dc2626;
  border: 1px solid #fecaca;
}

.status-message.info {
  background: #fffbeb;
  color: #d97706;
  border: 1px solid #fde68a;
}

@media (max-width: 640px) {
  .container {
    padding: 15px;
  }
  
  .card {
    padding: 25px;
  }
  
  .card-title {
    font-size: 20px;
  }
  
  .result-value {
    font-size: 18px;
  }
  
  .commission-highlight .result-value {
    font-size: 28px;
  }
}
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="logo-container">
      <img id="logo" class="logo" alt="Logo">
    </div>
  </header>

  <div id="gateScreen" class="gate-screen active">
    <div class="card">
      <h1 class="card-title">Bienvenido</h1>
      <div id="gateStatus" class="status-message"></div>
      <div class="form-group">
        <label for="userName">Nombre</label>
        <input type="text" id="userName" placeholder="Escribe tu nombre">
      </div>
      <button id="enterBtn" disabled>Entrar</button>
    </div>
  </div>

  <div id="calculatorScreen" class="calculator-screen">
    <div class="card">
      <h1 class="card-title">Calculadora de Comisiones</h1>
      <div id="calcStatus" class="status-message"></div>
      
      <div class="form-group">
        <label for="epcTable">Tabla EPC</label>
        <select id="epcTable">
          <option value="">Selecciona una opción</option>
          <option value="TESLA_1PW3">Tesla · 1 PW3 Hybrid</option>
          <option value="TESLA_2PW3">Tesla · 2 Baterías (PW3)</option>
          <option value="ENPHASE_2x5P">Enphase · 2 - 5P DOM</option>
          <option value="ENPHASE_3x5P">Enphase · 3 - 5P DOM</option>
          <option value="ENPHASE_4x5P">Enphase · 4 - 5P DOM</option>
        </select>
      </div>

      <div class="form-group">
        <label for="panelCount">Número de Paneles</label>
        <input type="number" id="panelCount" min="1" step="1" placeholder="Ej: 20">
      </div>

      <div class="form-group">
        <label for="contractPercent">Porcentaje de Contrato</label>
        <select id="contractPercent">
          <option value="">Selecciona un porcentaje</option>
          <option value="6">6%</option>
          <option value="10">10%</option>
          <option value="12">12%</option>
          <option value="13">13%</option>
          <option value="14">14%</option>
          <option value="15">15%</option>
        </select>
      </div>

      <button id="calculateBtn" disabled>Calcular</button>

      <div id="results" class="results">
        <div class="result-row">
          <span class="result-label">Total Watts</span>
          <span class="result-value" id="totalWatts">-</span>
        </div>
        <div class="result-row">
          <span class="result-label">kW</span>
          <span class="result-value" id="totalKw">-</span>
        </div>
        <div class="result-row">
          <span class="result-label">Precio</span>
          <span class="result-value" id="totalPrice">-</span>
        </div>
        <div class="commission-highlight">
          <div class="result-row">
            <span class="result-label">Tu Comisión</span>
            <span class="result-value" id="totalCommission">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const EPC_TABLES = {
  TESLA_1PW3: {
    10:5.15, 11:5.15, 12:4.94, 13:4.75, 14:4.58, 15:4.43,
    16:4.31, 17:4.19, 18:4.09, 19:4.00, 20:3.92,
    21:3.85, 22:3.79, 23:3.73, 24:3.67, 25:3.62,
    26:3.57, 27:3.53, 28:3.49, 29:3.45, 30:3.42,
    31:3.38, 32:3.35, 33:3.32
  },
  TESLA_2PW3: {
    22:5.01, 23:4.89, 24:4.79, 25:4.69, 26:4.60,
    27:4.52, 28:4.45, 29:4.38, 30:4.31, 31:4.25,
    32:4.19, 33:4.14, 34:4.09, 35:4.04, 36:3.99,
    37:3.95, 38:3.91, 39:3.87, 40:3.83, 41:3.80,
    42:3.76, 43:3.73, 44:3.70, 45:3.67, 46:3.65,
    47:3.62, 48:3.59, 49:3.57, 50:3.55, 51:3.52,
    52:3.50, 53:3.48, 54:3.46, 55:3.44, 56:3.42,
    57:3.41, 58:3.39, 59:3.37, 60:3.36, 61:3.34,
    62:3.32, 63:3.31, 64:3.30, 65:3.28, 66:3.27
  },
  ENPHASE_2x5P: {
    10:4.96, 11:4.84, 12:4.64, 13:4.46, 14:4.32, 15:4.19
  },
  ENPHASE_3x5P: {
    13:4.75, 14:4.56, 15:4.43, 16:4.31, 17:4.19,
    18:4.09, 19:4.00, 20:3.92, 21:3.85, 22:3.79,
    23:3.73, 24:3.67, 25:3.62, 26:3.57, 27:3.53,
    28:3.49, 29:3.45, 30:3.42, 31:3.38, 32:3.35,
    33:3.32, 34:3.30, 35:3.27, 36:3.25, 37:3.22,
    38:3.20, 39:3.18, 40:3.16
  },
  ENPHASE_4x5P: {
    22:4.28, 23:4.20, 24:4.13, 25:4.06, 26:3.99,
    27:3.94, 28:3.88, 29:3.83, 30:3.78, 31:3.74,
    32:3.70, 33:3.66, 34:3.62, 35:3.58, 36:3.55,
    37:3.52, 38:3.49, 39:3.46, 40:3.44, 41:3.41,
    42:3.39, 43:3.36, 44:3.34, 45:3.32, 46:3.30,
    47:3.28, 48:3.26, 49:3.25, 50:3.23, 51:3.21,
    52:3.20, 53:3.18, 54:3.17, 55:3.15, 56:3.14,
    57:3.13, 58:3.11, 59:3.10, 60:3.09, 61:3.08,
    62:3.07, 63:3.06, 64:3.05
  }
};

const LOGOS = ['palmetto.png', 'Lightreach.png'];
const SESSION_DURATION = 10 * 60 * 1000;

let sessionCheckInterval = null;

function loadLogo() {
  const logoEl = document.getElementById('logo');
  const statusEl = document.getElementById('gateStatus');
  
  let currentIndex = 0;
  
  function tryNextLogo() {
    if (currentIndex >= LOGOS.length) {
      showStatus(statusEl, 'No se encontró el logo', 'info');
      return;
    }
    
    const img = new Image();
    img.onload = function() {
      logoEl.src = LOGOS[currentIndex];
      logoEl.classList.add('loaded');
    };
    img.onerror = function() {
      currentIndex++;
      tryNextLogo();
    };
    img.src = LOGOS[currentIndex];
  }
  
  tryNextLogo();
}

function showStatus(element, message, type) {
  element.textContent = message;
  element.className = 'status-message visible ' + type;
}

function hideStatus(element) {
  element.className = 'status-message';
}

function checkSession() {
  const session = localStorage.getItem('userSession');
  if (!session) return false;
  
  try {
    const data = JSON.parse(session);
    const now = Date.now();
    if (now - data.timestamp > SESSION_DURATION) {
      clearSession();
      return false;
    }
    return true;
  } catch (e) {
    clearSession();
    return false;
  }
}

function clearSession() {
  localStorage.removeItem('userSession');
  if (sessionCheckInterval) {
    clearInterval(sessionCheckInterval);
    sessionCheckInterval = null;
  }
}

function startSessionCheck() {
  if (sessionCheckInterval) {
    clearInterval(sessionCheckInterval);
  }
  
  sessionCheckInterval = setInterval(function() {
    if (!checkSession()) {
      showGateScreen();
      const gateStatus = document.getElementById('gateStatus');
      showStatus(gateStatus, 'Sesión expirada. Escribe tu nombre otra vez.', 'info');
    }
  }, 10000);
}

function showGateScreen() {
  document.getElementById('gateScreen').classList.add('active');
  document.getElementById('calculatorScreen').classList.remove('active');
  document.getElementById('userName').value = '';
  document.getElementById('enterBtn').disabled = true;
  hideStatus(document.getElementById('gateStatus'));
}

function showCalculatorScreen() {
  document.getElementById('gateScreen').classList.remove('active');
  document.getElementById('calculatorScreen').classList.add('active');
  startSessionCheck();
}

function validateGateInput() {
  const name = document.getElementById('userName').value.trim();
  document.getElementById('enterBtn').disabled = name.length < 2;
}

function handleGateSubmit() {
  const name = document.getElementById('userName').value.trim();
  if (name.length >= 2) {
    const session = {
      name: name,
      timestamp: Date.now()
    };
    localStorage.setItem('userSession', JSON.stringify(session));
    showCalculatorScreen();
  }
}

function validateCalculatorInputs() {
  const epcTable = document.getElementById('epcTable').value;
  const panelCount = document.getElementById('panelCount').value;
  const contractPercent = document.getElementById('contractPercent').value;
  
  const isValid = epcTable !== '' && 
                  panelCount !== '' && 
                  parseInt(panelCount) >= 1 &&
                  contractPercent !== '';
  
  document.getElementById('calculateBtn').disabled = !isValid;
}

function formatCurrency(value) {
  return '$' + value.toLocaleString('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

function calculate() {
  const epcTableKey = document.getElementById('epcTable').value;
  const panelCount = parseInt(document.getElementById('panelCount').value);
  const contractPercent = parseFloat(document.getElementById('contractPercent').value);
  const statusEl = document.getElementById('calcStatus');
  
  hideStatus(statusEl);
  
  const epcTable = EPC_TABLES[epcTableKey];
  if (!epcTable[panelCount]) {
    showStatus(statusEl, 'El número de paneles ' + panelCount + ' no está disponible en la tabla EPC seleccionada.', 'error');
    document.getElementById('results').classList.remove('visible');
    return;
  }
  
  const epcValue = epcTable[panelCount];
  const totalWatts = panelCount * 410;
  const totalKw = totalWatts / 1000;
  const price = totalWatts * epcValue;
  const commission = price * (contractPercent / 100);
  
  document.getElementById('totalWatts').textContent = totalWatts.toLocaleString('en-US') + ' W';
  document.getElementById('totalKw').textContent = totalKw.toFixed(2) + ' kW';
  document.getElementById('totalPrice').textContent = formatCurrency(price);
  document.getElementById('totalCommission').textContent = formatCurrency(commission);
  
  document.getElementById('results').classList.add('visible');
}

document.addEventListener('DOMContentLoaded', function() {
  loadLogo();
  
  if (checkSession()) {
    showCalculatorScreen();
  } else {
    showGateScreen();
  }
  
  document.getElementById('userName').addEventListener('input', validateGateInput);
  document.getElementById('userName').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      handleGateSubmit();
    }
  });
  
  document.getElementById('enterBtn').addEventListener('click', handleGateSubmit);
  
  document.getElementById('epcTable').addEventListener('change', validateCalculatorInputs);
  document.getElementById('panelCount').addEventListener('input', validateCalculatorInputs);
  document.getElementById('contractPercent').addEventListener('change', validateCalculatorInputs);
  
  document.getElementById('calculateBtn').addEventListener('click', calculate);
  
  document.getElementById('panelCount').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !document.getElementById('calculateBtn').disabled) {
      calculate();
    }
  });
  
  document.getElementById('epcTable').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !document.getElementById('calculateBtn').disabled) {
      calculate();
    }
  });
  
  document.getElementById('contractPercent').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !document.getElementById('calculateBtn').disabled) {
      calculate();
    }
  });
});
</script>

</body>
</html>
