<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EPC & Comisión</title>

  <style>
    :root{
      --bg:#fff;
      --text:#0b1220;
      --muted:#5b6b83;
      --line:#e6ecf3;

      --teal:#2b8a94;
      --navy:#0b1b3a;

      --green:#16a34a;
      --red:#b42318;

      /* ✅ solo detalles anaranjados */
      --orange:#F59E0B;
      --orangeSoft: rgba(245,158,11,.14);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }

    /* Header */
    .top{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 12px 0 14px;
      border-bottom:1px solid var(--line);
    }

    /* ✅ línea naranja sutil */
    .top:after{
      content:"";
      position:absolute;
      left:0; right:0;
      bottom:-1px;
      height:2px;
      background: var(--orange);
      opacity:.9;
    }

    .logo{
      height:40px;
      width:auto;
      display:block;
      object-fit:contain;
    }

    /* ✅ mini toolbar (acciones) */
    .tools{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .toolBtn{
      height:36px;
      padding: 0 12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--navy);
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      font-size:11px;
      cursor:pointer;
      white-space:nowrap;
    }

    /* ✅ sutil borde naranja */
    .toolBtn.primary{
      border-color: rgba(245,158,11,.45);
      box-shadow: 0 0 0 4px transparent;
    }
    .toolBtn:hover{
      box-shadow: 0 0 0 4px var(--orangeSoft);
    }

    /* ✅ switch simple */
    .switch{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 0 10px;
      height:36px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--navy);
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      font-size:11px;
      user-select:none;
    }
    .switch input{ width:auto; }

    /* Inputs */
    .controls{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.3fr .7fr .6fr auto;
      gap:10px;
      align-items:end;
    }

    label{
      display:block;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:1.4px;
      color:var(--muted);
      margin-bottom:8px;
      font-weight:900;
    }

    select,input{
      width:100%;
      padding: 12px 12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
      font-size:14px;
      font-weight:800;
    }

    /* ✅ focus con toque naranja */
    select:focus,input:focus{
      border-color: rgba(43,138,148,.45);
      box-shadow: 0 0 0 4px rgba(43,138,148,.10), 0 0 0 8px var(--orangeSoft);
    }

    .btn{
      height:42px;
      padding: 0 14px;
      border:1px solid rgba(245,158,11,.35);
      background: var(--navy);
      color:#fff;
      font-weight:900;
      letter-spacing:1px;
      text-transform:uppercase;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
      transition: transform .06s ease, box-shadow .15s ease;
    }

    .btn:hover{
      box-shadow: 0 10px 22px rgba(11,27,58,.10), 0 0 0 4px var(--orangeSoft);
      transform: translateY(-1px);
    }

    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    /* Results */
    .results{
      margin-top:18px;
      padding-top:18px;
      border-top:1px solid var(--line);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
      align-items:start;
    }

    .big{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:1.6px;
      color:var(--muted);
      font-weight:1000;
      margin-bottom:8px;
      position:relative;
      padding-bottom:8px;
    }

    /* ✅ barrita naranja */
    .big:after{
      content:"";
      position:absolute;
      left:0;
      bottom:0;
      width:44px;
      height:2px;
      background: var(--orange);
      opacity:.9;
    }

    .value{
      font-size:34px;
      font-weight:1000;
      letter-spacing:.2px;
      color:var(--text);
    }
    .value.green{ color: var(--green); }

    .meta{
      margin-top:14px;
      display:flex;
      gap:18px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    .status{
      margin-top:10px;
      font-size:12px;
      font-weight:800;
      color:var(--muted);
    }
    .status.bad{ color: var(--red); }

    /* ✅ Desglose */
    .breakdown{
      margin-top:14px;
      padding-top:14px;
      border-top:1px solid var(--line);
      display:none;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      line-height:1.7;
    }
    .breakdown strong{ color: var(--navy); }

    /* ✅ Modo presentación: solo agranda números */
    .present .value{ font-size:46px; }
    .present .big{ font-size:12px; }

    @media (max-width: 900px){
      .controls{ grid-template-columns: 1fr; }
      .btn{ width:100%; }
      .results{ grid-template-columns: 1fr; }
    }

    /* Acceso */
    .gate{
      margin-top:18px;
      padding-top:18px;
      border-top:1px solid var(--line);
      display:grid;
      gap:12px;
      max-width:520px;
    }
    .gateTitle{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:1.6px;
      color:var(--muted);
      font-weight:1000;
    }
    .helper{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      margin-top:-6px;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap" id="wrap">
    <div class="top">
      <img class="logo" src="Lightreach.png" alt="LightReach"
           onerror="this.style.display='none'; document.getElementById('status').textContent='No encuentro el logo: Lightreach.png (case-sensitive)'; document.getElementById('status').classList.add('bad');">
    </div>

    <!-- ✅ ACCESO (se guarda por 10 min) -->
    <div id="gate" class="gate">
      <div class="gateTitle">Acceso</div>
      <div class="helper">Escribe tu nombre para entrar a la calculadora.</div>

      <div>
        <label>Nombre</label>
        <input id="gateName" type="text" autocomplete="name" placeholder="Ej. Carlos Rivera" />
      </div>

      <button class="btn" id="enterBtn" disabled>Entrar</button>
      <div class="status" id="gateStatus">Listo.</div>
    </div>

    <!-- ✅ CALCULADORA -->
    <div id="app" class="hidden">
      <!-- ✅ acciones pro -->
      <div class="tools">
        <button class="toolBtn primary" id="toggleBreakdownBtn" type="button">Ver desglose</button>
        <button class="toolBtn primary" id="copyBtn" type="button">Copiar resultado</button>
        <button class="toolBtn" id="clearBtn" type="button">Limpiar</button>

        <label class="switch" title="Agrandar números para mostrar en persona">
          <input id="presentToggle" type="checkbox" />
          Modo presentación
        </label>
      </div>

      <div class="controls">
        <div>
          <label>Tabla EPC</label>
          <select id="tableSelect">
            <option value="TESLA_1PW3">Tesla · 1 PW3 Hybrid</option>
            <option value="TESLA_2PW3">Tesla · 2 Baterías (PW3)</option>
            <option value="ENPHASE_2x5P">Enphase · 2 - 5P DOM</option>
            <option value="ENPHASE_3x5P">Enphase · 3 - 5P DOM</option>
            <option value="ENPHASE_4x5P">Enphase · 4 - 5P DOM</option>
          </select>
        </div>

        <div>
          <label># Paneles</label>
          <input id="panels" type="number" min="1" step="1" value="10" />
        </div>

        <div>
          <label>% Contrato</label>
          <select id="pct">
            <option value="" selected disabled>Selecciona…</option>
            <option value="6">6%</option>
            <option value="10">10%</option>
            <option value="12">12%</option>
            <option value="13">13%</option>
            <option value="14">14%</option>
            <option value="15">15%</option>
          </select>
        </div>

        <button class="btn" id="calcBtn" disabled>Calcular</button>
      </div>

      <div class="results">
        <div>
          <div class="big">Precio</div>
          <div class="value" id="outPrice">—</div>
        </div>

        <div>
          <div class="big">Comisión</div>
          <div class="value green" id="outCommission">—</div>
        </div>
      </div>

      <div class="meta" id="outMeta">
        <span>Watts: —</span>
        <span>kW: —</span>
        <span>EPC: —</span>
      </div>

      <!-- ✅ desglose -->
      <div class="breakdown" id="breakdown">
        <div><strong>Watts:</strong> <span id="bdWatts">—</span> (410 × paneles)</div>
        <div><strong>kW:</strong> <span id="bdKw">—</span></div>
        <div><strong>Precio:</strong> <span id="bdPrice">—</span> (<span id="bdWatts2">—</span> × <span id="bdEpc">—</span>)</div>
        <div><strong>Comisión:</strong> <span id="bdComm">—</span> (<span id="bdPrice2">—</span> × <span id="bdPct">—</span>)</div>
      </div>

      <div class="status" id="status">Listo. Selecciona tu % y presiona “Calcular”.</div>
    </div>
  </div>

  <script>
    const WATTS_PER_PANEL = 410;
    const SESSION_MS = 10 * 60 * 1000; // ✅ 10 minutos

    // ✅ preferencias (no nombre)
    const PREF_TABLE = "lr_pref_table";
    const PREF_PANELS = "lr_pref_panels";
    const PREF_PCT = "lr_pref_pct";
    const PREF_PRESENT = "lr_pref_present";

    const EPC_TABLES = {
      TESLA_1PW3: {
        10: 5.15, 11: 5.15, 12: 4.94, 13: 4.75, 14: 4.58, 15: 4.43,
        16: 4.31, 17: 4.19, 18: 4.09, 19: 4.00, 20: 3.92, 21: 3.85,
        22: 3.79, 23: 3.73, 24: 3.67, 25: 3.62, 26: 3.57, 27: 3.53,
        28: 3.49, 29: 3.45, 30: 3.42, 31: 3.38, 32: 3.35, 33: 3.32
      },

      TESLA_2PW3: {
        22: 5.01, 23: 4.89, 24: 4.79, 25: 4.69, 26: 4.60, 27: 4.52,
        28: 4.45, 29: 4.38, 30: 4.31, 31: 4.25, 32: 4.19, 33: 4.14,
        34: 4.09, 35: 4.04, 36: 3.99, 37: 3.95, 38: 3.91, 39: 3.87,
        40: 3.83, 41: 3.80, 42: 3.76, 43: 3.73, 44: 3.70, 45: 3.67,
        46: 3.65, 47: 3.62, 48: 3.59, 49: 3.57, 50: 3.55, 51: 3.52,
        52: 3.50, 53: 3.48, 54: 3.46, 55: 3.44, 56: 3.42, 57: 3.41,
        58: 3.39, 59: 3.37, 60: 3.36, 61: 3.34, 62: 3.32, 63: 3.31,
        64: 3.30, 65: 3.28, 66: 3.27
      },

      ENPHASE_2x5P: { 10: 4.96, 11: 4.84, 12: 4.64, 13: 4.46, 14: 4.32, 15: 4.19 },

      ENPHASE_3x5P: {
        13: 4.75, 14: 4.56, 15: 4.43, 16: 4.31, 17: 4.19, 18: 4.09,
        19: 4.00, 20: 3.92, 21: 3.85, 22: 3.79, 23: 3.73, 24: 3.67,
        25: 3.62, 26: 3.57, 27: 3.53, 28: 3.49, 29: 3.45, 30: 3.42,
        31: 3.38, 32: 3.35, 33: 3.32, 34: 3.30, 35: 3.27, 36: 3.25,
        37: 3.22, 38: 3.20, 39: 3.18, 40: 3.16
      },

      ENPHASE_4x5P: {
        22: 4.28, 23: 4.20, 24: 4.13, 25: 4.06, 26: 3.99, 27: 3.94,
        28: 3.88, 29: 3.83, 30: 3.78, 31: 3.74, 32: 3.70, 33: 3.66,
        34: 3.62, 35: 3.58, 36: 3.55, 37: 3.52, 38: 3.49, 39: 3.46,
        40: 3.44, 41: 3.41, 42: 3.39, 43: 3.36, 44: 3.34, 45: 3.32,
        46: 3.30, 47: 3.28, 48: 3.26, 49: 3.25, 50: 3.23, 51: 3.21,
        52: 3.20, 53: 3.18, 54: 3.17, 55: 3.15, 56: 3.14, 57: 3.13,
        58: 3.11, 59: 3.10, 60: 3.09, 61: 3.08, 62: 3.07, 63: 3.06,
        64: 3.05
      }
    };

    const $ = (id) => document.getElementById(id);

    const money = (n) => {
      if (!isFinite(n)) return "—";
      return new Intl.NumberFormat("en-US", {
        style:"currency", currency:"USD", maximumFractionDigits:2
      }).format(n);
    };

    const num = (n, d=2) => {
      if (!isFinite(n)) return "—";
      return new Intl.NumberFormat("en-US", { maximumFractionDigits:d }).format(n);
    };

    function setStatus(ok, msg){
      const el = $("status");
      if (!el) return;
      el.textContent = msg;
      el.classList.toggle("bad", !ok);
    }
    function setGateStatus(msg){ $("gateStatus").textContent = msg; }

    /* ====== ACCESO (TEMPORAL 10 MIN) ====== */
    function gateReady(){
      const name = ($("gateName").value || "").trim();
      return name.length >= 2;
    }
    function updateGate(){ $("enterBtn").disabled = !gateReady(); }

    function openGate(msg="Listo."){
      $("app").classList.add("hidden");
      $("gate").classList.remove("hidden");
      $("gateName").value = "";
      updateGate();
      setGateStatus(msg);
    }

    function openApp(){
      $("gate").classList.add("hidden");
      $("app").classList.remove("hidden");
      updateButton();
      setStatus(true, "Listo. Selecciona tu % y presiona “Calcular”.");
    }

    function saveSession(name){
      try{
        localStorage.setItem("lr_name", name);
        localStorage.setItem("lr_ts", String(Date.now()));
      }catch(_){}
    }
    function clearSession(){
      try{
        localStorage.removeItem("lr_name");
        localStorage.removeItem("lr_ts");
      }catch(_){}
    }
    function sessionValid(){
      try{
        const name = (localStorage.getItem("lr_name") || "").trim();
        const ts = parseInt(localStorage.getItem("lr_ts") || "0", 10);
        if (!name || !ts) return false;
        return (Date.now() - ts) <= SESSION_MS;
      }catch(_){
        return false;
      }
    }

    function enterApp(){
      const name = ($("gateName").value || "").trim();
      if (!name){
        setGateStatus("Escribe tu nombre.");
        return;
      }
      saveSession(name);
      openApp();
    }

    $("gateName").addEventListener("input", updateGate);
    $("enterBtn").addEventListener("click", (e)=>{ e.preventDefault(); enterApp(); });

    /* ====== Preferencias (Tabla + Paneles + %) ====== */
    function savePrefs(){
      try{
        localStorage.setItem(PREF_TABLE, $("tableSelect").value);
        localStorage.setItem(PREF_PANELS, String($("panels").value || ""));
        localStorage.setItem(PREF_PCT, String($("pct").value || ""));
      }catch(_){}
    }
    function loadPrefs(){
      try{
        const t = localStorage.getItem(PREF_TABLE);
        const p = localStorage.getItem(PREF_PANELS);
        const pct = localStorage.getItem(PREF_PCT);

        if (t && EPC_TABLES[t]) $("tableSelect").value = t;
        if (p && String(parseInt(p,10)) === String(p)) $("panels").value = p;

        if (pct && ["6","10","12","13","14","15"].includes(pct)) $("pct").value = pct;
      }catch(_){}
    }

    /* ====== CALCULADORA ====== */
    function getRangeForTable(tableKey){
      const table = EPC_TABLES[tableKey] || {};
      const keys = Object.keys(table).map(k => parseInt(k,10)).filter(n => Number.isFinite(n)).sort((a,b)=>a-b);
      if (!keys.length) return null;
      return { min: keys[0], max: keys[keys.length - 1] };
    }

    function isReady(){
      const panels = parseInt($("panels").value || "0", 10);
      const pct = $("pct").value;
      const tableKey = $("tableSelect").value;

      if (!tableKey) return false;
      if (!panels || panels <= 0) return false;
      if (!pct) return false;
      return true;
    }

    function updateButton(){
      $("calcBtn").disabled = !isReady();
    }

    function resetOutputs(){
      $("outPrice").textContent = "—";
      $("outCommission").textContent = "—";
      $("outMeta").innerHTML = `<span>Watts: —</span><span>kW: —</span><span>EPC: —</span>`;
      updateBreakdown(null);
    }

    function updateBreakdown(data){
      const bd = $("breakdown");
      if (!data){
        $("bdWatts").textContent = "—";
        $("bdKw").textContent = "—";
        $("bdPrice").textContent = "—";
        $("bdComm").textContent = "—";
        $("bdWatts2").textContent = "—";
        $("bdEpc").textContent = "—";
        $("bdPrice2").textContent = "—";
        $("bdPct").textContent = "—";
        return;
      }

      $("bdWatts").textContent = `${num(data.watts,0)} W`;
      $("bdKw").textContent = `${num(data.kw,2)} kW`;
      $("bdWatts2").textContent = `${num(data.watts,0)} W`;
      $("bdEpc").textContent = `$${num(data.epc,2)}/W`;
      $("bdPrice").textContent = money(data.price);
      $("bdPrice2").textContent = money(data.price);
      $("bdPct").textContent = `${num(data.pct,0)}%`;
      $("bdComm").textContent = money(data.commission);
    }

    function calculate(){
      const tableKey = $("tableSelect").value;
      const panels = parseInt($("panels").value || "0", 10);
      const pct = parseFloat($("pct").value || "0");

      if (!panels || panels <= 0){
        resetOutputs();
        setStatus(false, "Pon una cantidad válida de paneles.");
        return;
      }

      if (!$("pct").value){
        setStatus(false, "Selecciona el % de contrato para calcular.");
        return;
      }

      const table = EPC_TABLES[tableKey] || {};
      const epc = table[panels];
      const watts = WATTS_PER_PANEL * panels;
      const kw = watts / 1000;

      if (!epc){
        resetOutputs();
        const range = getRangeForTable(tableKey);
        const hint = range ? ` Rango válido: ${range.min}–${range.max}.` : "";
        $("outMeta").innerHTML =
          `<span>Watts: ${num(watts,0)}</span><span>kW: ${num(kw,2)}</span><span>EPC: —</span>`;
        setStatus(false, `Ese # de paneles (${panels}) no existe en la tabla seleccionada.${hint}`);
        return;
      }

      const price = watts * epc;
      const commission = price * (pct / 100);

      $("outPrice").textContent = money(price);
      $("outCommission").textContent = money(commission);
      $("outMeta").innerHTML =
        `<span>Watts: ${num(watts,0)}</span><span>kW: ${num(kw,2)}</span><span>EPC: $${num(epc,2)}/W</span>`;

      updateBreakdown({ watts, kw, epc, price, pct, commission });

      setStatus(true, "Cálculo listo.");
      savePrefs();
    }

    $("calcBtn").addEventListener("click", (e) => {
      e.preventDefault();
      if (!isReady()){
        setStatus(false, "Completa paneles y selecciona el % antes de calcular.");
        return;
      }
      calculate();
    });

    ["input","change"].forEach(evt=>{
      $("panels").addEventListener(evt, () => { updateButton(); savePrefs(); });
      $("pct").addEventListener(evt, () => { updateButton(); savePrefs(); });
      $("tableSelect").addEventListener(evt, () => { updateButton(); savePrefs(); });
    });

    /* ====== (1) Ver desglose ====== */
    let breakdownOn = false;
    $("toggleBreakdownBtn").addEventListener("click", ()=>{
      breakdownOn = !breakdownOn;
      $("breakdown").style.display = breakdownOn ? "block" : "none";
      $("toggleBreakdownBtn").textContent = breakdownOn ? "Ocultar desglose" : "Ver desglose";
    });

    /* ====== (2) Copiar resultado ====== */
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(_){
        // fallback
        try{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          return true;
        }catch(__){
          return false;
        }
      }
    }

    $("copyBtn").addEventListener("click", async ()=>{
      const tableKey = $("tableSelect").value;
      const panels = parseInt($("panels").value || "0", 10);
      const pct = $("pct").value;

      const priceText = $("outPrice").textContent;
      const commText = $("outCommission").textContent;

      const range = getRangeForTable(tableKey);
      const rangeText = range ? `${range.min}-${range.max}` : "—";

      const msg =
`EPC & Comisión
Tabla: ${$("tableSelect").selectedOptions[0]?.textContent || tableKey}
Paneles: ${panels || "—"} (rango ${rangeText})
% Contrato: ${pct || "—"}
Precio: ${priceText}
Comisión: ${commText}`;

      const ok = await copyText(msg);
      setStatus(ok, ok ? "Copiado. Pégalo en WhatsApp." : "No pude copiar (bloqueado por el navegador).");
    });

    /* ====== (3) Limpiar ====== */
    $("clearBtn").addEventListener("click", ()=>{
      $("panels").value = "10";
      $("pct").value = "";
      resetOutputs();
      updateButton();
      setStatus(true, "Listo. Selecciona tu % y presiona “Calcular”.");
      savePrefs();
    });

    /* ====== (6) Modo presentación ====== */
    function setPresent(on){
      $("wrap").classList.toggle("present", !!on);
      try{ localStorage.setItem(PREF_PRESENT, on ? "1" : "0"); }catch(_){}
    }
    $("presentToggle").addEventListener("change", (e)=>{
      setPresent(e.target.checked);
    });

    /* ====== ENTER KEY ====== */
    document.addEventListener("keydown", (e)=>{
      if (e.key !== "Enter") return;

      // si está en acceso
      if (!$("gate").classList.contains("hidden")){
        if (gateReady()) enterApp();
        return;
      }

      // si está en calculadora
      if (!isReady()){
        setStatus(false, "Completa paneles y selecciona el % antes de calcular.");
        return;
      }
      calculate();
    });

    /* ====== BOOT + reset por 10 min ====== */
    (function boot(){
      // cargar prefs (antes de mostrar)
      loadPrefs();
      updateButton();
      resetOutputs();

      // present mode persist
      try{
        const p = localStorage.getItem(PREF_PRESENT);
        if (p === "1"){
          $("presentToggle").checked = true;
          setPresent(true);
        }
      }catch(_){}

      // acceso temporal
      if (!sessionValid()){
        clearSession();
        openGate("Listo.");
      }else{
        openApp();
      }

      // chequeo de expiración si dejan la página abierta
      setInterval(()=>{
        if (!$("app").classList.contains("hidden") && !sessionValid()){
          clearSession();
          openGate("Sesión expirada. Escribe tu nombre otra vez.");
        }
      }, 10000);
    })();
  </script>
</body>
</html>
