<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADVENCY SOLAR ‚Äî Auditor√≠a & Dashboard</title>
  <style>
    :root{
      --bg:#FFFFFF;
      --paper:#FFFFFF;
      --ink:#0B1220;
      --muted:#5B6475;
      --line:#E6E8EE;
      --line2:#D6DAE5;

      --brand:#0A1F44;
      --accent:#00B4D8;

      --ok:#16A34A;
      --na:#DC2626;
      --improve:#D97706;
      --todo:#6D28D9;

      --shadow: 0 14px 40px rgba(10, 31, 68, .08);
      --shadow2: 0 10px 22px rgba(10, 31, 68, .06);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--sans);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 28px 18px 80px;
    }

    /* Top bar */
    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      padding-bottom:18px;
      border-bottom:1px solid var(--line);
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title{
      font-size: 18px;
      letter-spacing:.06em;
      font-weight: 800;
      color:var(--brand);
      text-transform:uppercase;
    }
    .subtitle{
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
      max-width: 720px;
    }
    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    button, .pill{
      border:1px solid var(--line2);
      background:var(--paper);
      color:var(--ink);
      padding: 10px 12px;
      font-size: 12px;
      letter-spacing:.04em;
      text-transform:uppercase;
      font-weight:700;
      cursor:pointer;
      border-radius:0;
      box-shadow:none;
    }
    button:hover{ border-color:var(--brand); }
    .pill{
      cursor:default;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:0;background:var(--accent);
    }

    /* Tabs */
    .tabs{
      margin-top:18px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .tab{
      border:1px solid var(--line2);
      background:var(--paper);
      padding:10px 12px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.06em;
      font-weight:800;
      cursor:pointer;
      border-radius:0;
      position:relative;
    }
    .tab.active{
      border-color:var(--brand);
      color:var(--brand);
      box-shadow: inset 0 -2px 0 var(--accent);
    }
    .tab small{
      font-size:11px;
      font-weight:800;
      color:var(--muted);
      margin-left:8px;
      font-family:var(--mono);
    }

    /* Panels */
    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--paper);
      border:1px solid var(--line);
      box-shadow: var(--shadow2);
      border-radius:0;
    }
    .card h3{
      margin:0;
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--brand);
    }
    .card .body{ padding: 14px; }

    /* Dashboard blocks */
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      border:1px solid var(--line);
      padding:12px;
      border-radius:0;
      background: #FBFCFF;
    }
    .kpi .label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      font-weight:800;
    }
    .kpi .value{
      margin-top:6px;
      font-family:var(--mono);
      font-weight:900;
      font-size:22px;
      color:var(--brand);
    }

    .bars{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .barrow{
      display:grid;
      grid-template-columns: 130px 1fr 54px;
      gap:10px;
      align-items:center;
    }
    .barrow .dept{
      font-size:12px;
      font-weight:800;
      color:var(--ink);
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .barwrap{
      height:10px;
      border:1px solid var(--line);
      background:#F6F7FB;
      position:relative;
      overflow:hidden;
    }
    .barfill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--brand), var(--accent));
    }
    .barpct{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      text-align:right;
      font-weight:800;
    }

    .legend{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }
    .leg{
      display:flex;align-items:center;gap:8px;
    }
    .sw{
      width:12px;height:12px;border-radius:0;border:1px solid var(--line2);
    }

    /* Table */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead th{
      text-align:left;
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      background:#FBFCFF;
    }
    tbody td{
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    tbody tr:hover{ background:#FBFCFF; }
    .item{
      font-weight:800;
      color:#0B1220;
      line-height:1.3;
    }
    .focus{
      color:var(--muted);
      font-family:var(--mono);
      font-size:12px;
      letter-spacing:.02em;
    }

    /* Status controls */
    .status{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line2);
      border-radius:0;
      cursor:pointer;
      user-select:none;
      background:#FFFFFF;
      font-size:12px;
      font-weight:800;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .chip input{ display:none; }
    .chip .mini{
      width:10px;height:10px;border-radius:0;background:#999;
    }
    .chip.ok .mini{ background:var(--ok); }
    .chip.na .mini{ background:var(--na); }
    .chip.improve .mini{ background:var(--improve); }
    .chip.todo .mini{ background:var(--todo); }

    .chip.active{
      border-color:var(--brand);
      box-shadow: inset 0 -2px 0 var(--accent);
    }

    /* Detail inputs */
    .details{
      display:grid;
      grid-template-columns: 1.2fr .8fr .8fr;
      gap:8px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .details{ grid-template-columns: 1fr; }
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.1em;
      font-weight:900;
      color:var(--muted);
    }
    input[type="text"], input[type="date"], textarea{
      width:100%;
      border:1px solid var(--line2);
      border-radius:0;
      padding:10px 10px;
      font-size:13px;
      font-family:var(--sans);
      outline:none;
      background:#FFFFFF;
    }
    textarea{
      min-height: 38px;
      resize:vertical;
    }
    input:focus, textarea:focus{
      border-color:var(--brand);
      box-shadow: 0 0 0 3px rgba(0,180,216,.12);
    }

    .rowmeta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }
    .badge{
      font-family:var(--mono);
      font-weight:900;
      padding:4px 6px;
      border:1px solid var(--line2);
      border-radius:0;
      background:#FFFFFF;
      color:var(--brand);
    }

    /* Small list */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .task{
      border:1px solid var(--line);
      background:#FBFCFF;
      padding:10px;
      border-radius:0;
    }
    .task .t{
      font-weight:900;
      color:var(--ink);
      margin-bottom:4px;
      font-size:13px;
    }
    .task .s{
      font-size:12px;
      color:var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      font-family:var(--mono);
    }

    .footer-note{
      margin-top:18px;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    .footer-note strong{ color:var(--brand); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="title">ADVENCY SOLAR ‚Äî Auditor√≠a Operativa</div>
        <div class="subtitle">
          Marca <strong>una opci√≥n por fila</strong>: <strong>Bien</strong>, <strong>No es relevante</strong>, <strong>Para mejora</strong> o <strong>Hacer</strong>.
          Si eliges ‚ÄúPara mejora‚Äù o ‚ÄúHacer‚Äù, escribe la tarea, asigna owner y fecha. Todo se guarda solo.
        </div>
      </div>
      <div class="actions">
        <div class="pill"><span class="dot"></span><span id="saveStatus">Guardado autom√°tico</span></div>
        <button id="btnExport">Exportar JSON</button>
        <button id="btnReset">Reset</button>
      </div>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="grid">
      <div class="card">
        <h3 id="sectionTitle">Departamento</h3>
        <div class="body" id="sectionBody"></div>
      </div>

      <div class="card">
        <h3>Dashboard de salud</h3>
        <div class="body">
          <div class="kpis">
            <div class="kpi">
              <div class="label">Salud total</div>
              <div class="value" id="kpiTotal">0%</div>
            </div>
            <div class="kpi">
              <div class="label">Pendientes (Hacer)</div>
              <div class="value" id="kpiTodo">0</div>
            </div>
            <div class="kpi">
              <div class="label">Para mejora</div>
              <div class="value" id="kpiImprove">0</div>
            </div>
            <div class="kpi">
              <div class="label">Bien</div>
              <div class="value" id="kpiOk">0</div>
            </div>
          </div>

          <div class="legend">
            <div class="leg"><span class="sw" style="background:var(--ok)"></span>Bien</div>
            <div class="leg"><span class="sw" style="background:var(--na)"></span>No relevante</div>
            <div class="leg"><span class="sw" style="background:var(--improve)"></span>Para mejora</div>
            <div class="leg"><span class="sw" style="background:var(--todo)"></span>Hacer</div>
          </div>

          <div class="bars" id="bars"></div>

          <div class="footer-note">
            <strong>C√≥mo leerlo:</strong> ‚ÄúSalud %‚Äù = (Bien / (Bien + Para mejora + Hacer)) ‚Äî los ‚ÄúNo relevantes‚Äù no cuentan.
            Enf√≥cate primero en los <strong>Hacer</strong> del dept con menor %.
          </div>

          <div class="card" style="margin-top:14px;">
            <h3>Top pendientes (Hacer / Para mejora)</h3>
            <div class="body">
              <div class="list" id="topTasks"></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
/** --------------------------
 * Data Model
 * status: "ok" | "na" | "improve" | "todo" | null
 * -------------------------- */

const DEPTS = [
  {
    id: "oferta",
    name: "Oferta",
    items: [
      { item: "ICP claro (Residencial PR con LUMA + consumo m√≠nimo)", focus: "Nicho" },
      { item: "Promesa concreta: X citas cualificadas/mes (no solo leads)", focus: "Promesa" },
      { item: "Definici√≥n de lead cualificado documentada", focus: "Calificaci√≥n" },
      { item: "3 tiers (Starter / Growth / Elite) definidos", focus: "Paquetes" },
      { item: "Onboarding checklist (accesos/pixel/CRM/calendario/WA)", focus: "Onboarding" },
      { item: "Propuesta 1-pager lista (PDF/Canva)", focus: "Ventas" },
      { item: "Proof: casos de √©xito/screenshots", focus: "Proof" },
      { item: "SLA: tiempo de respuesta a lead definido", focus: "Operaci√≥n" },
      { item: "Pol√≠tica de t√©rminos/cancelaci√≥n", focus: "Legal" },
      { item: "Stack definido (Ads/CRM/Tracking/WA)", focus: "Sistema" },
    ]
  },
  {
    id: "finanzas",
    name: "Finanzas",
    items: [
      { item: "Pricing rentable (incluye herramientas + tiempo)", focus: "Pricing" },
      { item: "Modelo setup + mensual (o m√≠nimo ads) definido", focus: "Modelo" },
      { item: "Meta mensual y meta semanal definidas", focus: "Metas" },
      { item: "CPL objetivo definido ($15‚Äì$40)", focus: "Ads" },
      { item: "Costo por cita objetivo definido ($40‚Äì$120)", focus: "Ads" },
      { item: "Show rate objetivo definido (>=60%)", focus: "KPI" },
      { item: "Close rate objetivo definido (>=15%)", focus: "KPI" },
      { item: "Autopay configurado + fechas fijas", focus: "Cobro" },
      { item: "Contrato/retainer listo", focus: "Legal" },
      { item: "Plan de escalamiento (cu√°ndo contratar)", focus: "Escala" },
    ]
  },
  {
    id: "operaciones",
    name: "Operaciones",
    items: [
      { item: "SOP lanzamiento campa√±as (checklist)", focus: "SOP" },
      { item: "SOP creativos (brief + formatos + hooks)", focus: "SOP" },
      { item: "Tracking: Pixel/CAPI/API + UTMs + eventos", focus: "Tracking" },
      { item: "Naming conventions (campa√±as/adsets/ads)", focus: "Orden" },
      { item: "Librer√≠a de creativos organizada", focus: "Creativos" },
      { item: "SOP testing (reglas de cambio)", focus: "Optimizaci√≥n" },
      { item: "Accesos documentados (BM/Ads/CRM/WA)", focus: "Seguridad" },
      { item: "Template de auditor√≠a inicial por cliente", focus: "Onboarding" },
      { item: "Sistema de tareas (Notion/Trello)", focus: "Gesti√≥n" },
      { item: "QA semanal (forms, automations, calendar, WA)", focus: "Calidad" },
    ]
  },
  {
    id: "delivery",
    name: "Delivery",
    items: [
      { item: "Formulario pre-calificaci√≥n (LUMA/consumo/due√±o/techo)", focus: "Precalificaci√≥n" },
      { item: "Calendario con reglas (buffers/horarios)", focus: "Citas" },
      { item: "WhatsApp: confirmaci√≥n inmediata", focus: "Automatizaci√≥n" },
      { item: "Secuencia anti no-show (24h/3h/1h/15m)", focus: "No-show" },
      { item: "Setter script (calificar + agendar)", focus: "Setter" },
      { item: "SLA respuesta < 15 min", focus: "Velocidad" },
      { item: "Pipeline CRM: Lead‚ÜíCalificado‚ÜíCita‚ÜíShow‚ÜíCierre", focus: "CRM" },
      { item: "Reactivaci√≥n leads fr√≠os (7/14/30 d√≠as)", focus: "Seguimiento" },
      { item: "Reporte semanal: citas/show/CPL/CPA-cita", focus: "Reportes" },
      { item: "Auditor√≠a de calidad: 5 leads/semana", focus: "Calidad" },
    ]
  },
  {
    id: "personas",
    name: "Personas",
    items: [
      { item: "Roles definidos (Media buyer/Setter/VA/Closer)", focus: "Roles" },
      { item: "Training b√°sico para setter", focus: "Training" },
      { item: "Training b√°sico para closer (cliente)", focus: "Training" },
      { item: "Scorecards por rol (citas/show/close)", focus: "KPI" },
      { item: "Reuni√≥n semanal de performance", focus: "Ritmo" },
      { item: "Sistema de bonos/comisiones (si aplica)", focus: "Incentivos" },
      { item: "Biblioteca de respuestas WA (macros)", focus: "Scripts" },
      { item: "Back-up process (si alguien falla)", focus: "Riesgo" },
      { item: "SOP onboarding interno", focus: "SOP" },
      { item: "Cultura de velocidad (responder r√°pido)", focus: "Cultura" },
    ]
  },
  {
    id: "marketing",
    name: "Marketing",
    items: [
      { item: "Bio clara + CTA (citas para consultores solares PR)", focus: "Perfil" },
      { item: "10 piezas base (educativo/autoridad)", focus: "Contenido" },
      { item: "Landing de agencia (aplicar/agendar)", focus: "Funnel" },
      { item: "Caso de √©xito visible", focus: "Prueba" },
      { item: "Sistema DM outbound (script)", focus: "Prospecci√≥n" },
      { item: "Lead magnet (checklist show rate)", focus: "Lead Magnet" },
      { item: "Calendario de contenido semanal", focus: "Plan" },
      { item: "Lista de prospectos semanal", focus: "Prospecci√≥n" },
      { item: "Sistema de referrals", focus: "Referidos" },
      { item: "Ads de agencia (si aplica)", focus: "Ads" },
    ]
  },
  {
    id: "ventas",
    name: "Ventas",
    items: [
      { item: "Pipeline agencia (Lead‚ÜíCall‚ÜíProposal‚ÜíClose)", focus: "Pipeline" },
      { item: "Script discovery call", focus: "Call" },
      { item: "Script objeciones (caro/ya tengo leads/etc.)", focus: "Objeciones" },
      { item: "Pitch 1-pager / deck", focus: "Pitch" },
      { item: "Oferta con condiciones claras (ads aparte/90 d√≠as)", focus: "Oferta" },
      { item: "Seguimiento 7‚Äì14 d√≠as automatizado", focus: "Follow-up" },
      { item: "KPI ventas: show rate y close rate", focus: "KPI" },
      { item: "Pago + contrato en 1 paso", focus: "Cierre" },
      { item: "Handoff a delivery en 48h", focus: "Operaci√≥n" },
      { item: "Primer win r√°pido (primeras citas 7‚Äì10 d√≠as)", focus: "Entrega" },
    ]
  },
];

const STORAGE_KEY = "advency_audit_v1_white";

/** State format:
 * state[deptId][index] = { status, task, owner, date, note, evidence }
 */
let state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return makeEmptyState();
    const parsed = JSON.parse(raw);
    return normalizeState(parsed);
  } catch(e){
    return makeEmptyState();
  }
}

function makeEmptyState(){
  const s = {};
  for(const d of DEPTS){
    s[d.id] = d.items.map(_ => ({
      status: null,
      task: "",
      owner: "",
      date: "",
      note: "",
      evidence: ""
    }));
  }
  return s;
}

function normalizeState(s){
  const base = makeEmptyState();
  for(const d of DEPTS){
    if(!Array.isArray(s?.[d.id])) continue;
    for(let i=0;i<d.items.length;i++){
      const row = s[d.id][i] || {};
      base[d.id][i] = {
        status: ["ok","na","improve","todo",null].includes(row.status) ? row.status : null,
        task: String(row.task || ""),
        owner: String(row.owner || ""),
        date: String(row.date || ""),
        note: String(row.note || ""),
        evidence: String(row.evidence || "")
      };
    }
  }
  return base;
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  flashSaved();
  renderDashboard();
  renderTabBadges();
}

let saveTimer = null;
function scheduleSave(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(saveState, 120);
}

function flashSaved(){
  const el = document.getElementById("saveStatus");
  el.textContent = "Guardado";
  setTimeout(()=> el.textContent = "Guardado autom√°tico", 700);
}

/* UI: Tabs */
const tabsEl = document.getElementById("tabs");
let activeDept = DEPTS[0].id;

function renderTabs(){
  tabsEl.innerHTML = "";
  for(const d of DEPTS){
    const b = document.createElement("button");
    b.className = "tab" + (d.id===activeDept ? " active": "");
    b.dataset.dept = d.id;
    b.innerHTML = `${d.name} <small id="badge-${d.id}"></small>`;
    b.onclick = () => { activeDept = d.id; renderTabs(); renderDept(); };
    tabsEl.appendChild(b);
  }
  renderTabBadges();
}

function renderTabBadges(){
  for(const d of DEPTS){
    const badge = document.getElementById(`badge-${d.id}`);
    if(!badge) continue;
    const { health } = calcDept(d.id);
    badge.textContent = `${health}%`;
  }
}

/* Dept table */
function renderDept(){
  const dept = DEPTS.find(x=>x.id===activeDept);
  document.getElementById("sectionTitle").textContent = `Departamento ‚Äî ${dept.name}`;

  const container = document.getElementById("sectionBody");
  container.innerHTML = "";

  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th style="width:34%;">√çtem</th>
        <th style="width:14%;">Focus</th>
        <th style="width:52%;">Estado + Detalles</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  dept.items.forEach((it, idx)=>{
    const rowState = state[dept.id][idx];

    const tr = document.createElement("tr");
    const td1 = document.createElement("td");
    td1.innerHTML = `<div class="item">${escapeHtml(it.item)}</div>`;
    const td2 = document.createElement("td");
    td2.innerHTML = `<div class="focus">${escapeHtml(it.focus)}</div>`;

    const td3 = document.createElement("td");
    td3.appendChild(renderStatusControls(dept.id, idx, rowState.status));
    td3.appendChild(renderDetails(dept.id, idx, rowState));
    td3.appendChild(renderMeta(dept.id, idx, rowState));

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tbody.appendChild(tr);
  });

  container.appendChild(table);
}

function renderStatusControls(deptId, idx, current){
  const wrap = document.createElement("div");
  wrap.className = "status";

  const options = [
    { key:"ok", label:"Bien", cls:"ok" },
    { key:"na", label:"No relevante", cls:"na" },
    { key:"improve", label:"Para mejora", cls:"improve" },
    { key:"todo", label:"Hacer", cls:"todo" },
  ];

  for(const opt of options){
    const chip = document.createElement("label");
    chip.className = `chip ${opt.cls}` + (current===opt.key ? " active":"");
    chip.innerHTML = `<span class="mini"></span><span>${opt.label}</span>`;
    chip.onclick = () => {
      state[deptId][idx].status = opt.key;
      scheduleSave();
      renderDept(); // re-render to refresh active chip
    };
    wrap.appendChild(chip);
  }

  return wrap;
}

function renderDetails(deptId, idx, rowState){
  const d = document.createElement("div");
  d.className = "details";

  d.appendChild(field("Tarea (qu√© har√°s)", "text", rowState.task, v=>{
    state[deptId][idx].task = v; scheduleSave();
  }));

  d.appendChild(field("Owner", "text", rowState.owner, v=>{
    state[deptId][idx].owner = v; scheduleSave();
  }));

  d.appendChild(field("Fecha", "date", rowState.date, v=>{
    state[deptId][idx].date = v; scheduleSave();
  }));

  // Nota + Evidencia (full width)
  const nota = fieldArea("Nota", rowState.note, v=>{
    state[deptId][idx].note = v; scheduleSave();
  });
  nota.style.gridColumn = "1 / -1";

  const ev = field("Evidencia (link/archivo)", "text", rowState.evidence, v=>{
    state[deptId][idx].evidence = v; scheduleSave();
  });
  ev.style.gridColumn = "1 / -1";

  d.appendChild(nota);
  d.appendChild(ev);

  return d;
}

function renderMeta(deptId, idx, rowState){
  const meta = document.createElement("div");
  meta.className = "rowmeta";
  const st = rowState.status ? rowState.status.toUpperCase() : "‚Äî";
  meta.innerHTML = `
    <span class="badge">${st}</span>
    <span>${rowState.owner ? "Owner: " + escapeHtml(rowState.owner) : "Owner: ‚Äî"}</span>
    <span>${rowState.date ? "Fecha: " + escapeHtml(rowState.date) : "Fecha: ‚Äî"}</span>
  `;
  return meta;
}

function field(label, type, value, onInput){
  const w = document.createElement("div");
  w.className = "field";
  const id = "f_" + Math.random().toString(16).slice(2);
  w.innerHTML = `<label for="${id}">${escapeHtml(label)}</label>`;
  const input = document.createElement("input");
  input.type = type;
  input.id = id;
  input.value = value || "";
  input.oninput = (e)=> onInput(e.target.value);
  w.appendChild(input);
  return w;
}

function fieldArea(label, value, onInput){
  const w = document.createElement("div");
  w.className = "field";
  const id = "t_" + Math.random().toString(16).slice(2);
  w.innerHTML = `<label for="${id}">${escapeHtml(label)}</label>`;
  const ta = document.createElement("textarea");
  ta.id = id;
  ta.value = value || "";
  ta.oninput = (e)=> onInput(e.target.value);
  w.appendChild(ta);
  return w;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/* Dashboard calculations */
function calcDept(deptId){
  const rows = state[deptId];
  let ok=0, na=0, improve=0, todo=0, totalCounted=0;

  for(const r of rows){
    if(r.status==="na"){ na++; continue; }
    if(r.status==="ok"){ ok++; totalCounted++; continue; }
    if(r.status==="improve"){ improve++; totalCounted++; continue; }
    if(r.status==="todo"){ todo++; totalCounted++; continue; }
    // null -> treat as pending (not counted as na; but does count as todo-like for health? we‚Äôll count it as todo)
    todo++; totalCounted++;
  }

  const health = totalCounted ? Math.round((ok / totalCounted) * 100) : 0;
  return { ok, na, improve, todo, totalCounted, health };
}

function calcTotal(){
  let ok=0, na=0, improve=0, todo=0, totalCounted=0;
  for(const d of DEPTS){
    const c = calcDept(d.id);
    ok += c.ok;
    na += c.na;
    improve += c.improve;
    todo += c.todo;
    totalCounted += c.totalCounted;
  }
  const health = totalCounted ? Math.round((ok / totalCounted) * 100) : 0;
  return { ok, na, improve, todo, totalCounted, health };
}

function renderDashboard(){
  const total = calcTotal();
  document.getElementById("kpiTotal").textContent = total.health + "%";
  document.getElementById("kpiTodo").textContent = total.todo;
  document.getElementById("kpiImprove").textContent = total.improve;
  document.getElementById("kpiOk").textContent = total.ok;

  // Bars per dept
  const bars = document.getElementById("bars");
  bars.innerHTML = "";
  for(const d of DEPTS){
    const c = calcDept(d.id);
    const row = document.createElement("div");
    row.className = "barrow";
    row.innerHTML = `
      <div class="dept">${d.name}</div>
      <div class="barwrap"><div class="barfill" style="width:${c.health}%"></div></div>
      <div class="barpct">${c.health}%</div>
    `;
    bars.appendChild(row);
  }

  // Top pending tasks
  const list = document.getElementById("topTasks");
  const pending = collectPending();
  list.innerHTML = "";
  if(pending.length === 0){
    const div = document.createElement("div");
    div.className = "task";
    div.innerHTML = `<div class="t">Todo en verde üéØ</div><div class="s">No tienes pendientes marcados.</div>`;
    list.appendChild(div);
    return;
  }
  pending.slice(0,8).forEach(p=>{
    const div = document.createElement("div");
    div.className = "task";
    div.innerHTML = `
      <div class="t">${escapeHtml(p.item)}</div>
      <div class="s">
        <span>${p.dept.toUpperCase()}</span>
        <span>${p.status.toUpperCase()}</span>
        <span>${p.owner ? "Owner: "+escapeHtml(p.owner) : "Owner: ‚Äî"}</span>
        <span>${p.date ? "Fecha: "+escapeHtml(p.date) : "Fecha: ‚Äî"}</span>
      </div>
    `;
    div.onclick = () => {
      activeDept = p.deptId;
      renderTabs();
      renderDept();
      window.scrollTo({ top: 0, behavior: "smooth" });
    };
    list.appendChild(div);
  });
}

function collectPending(){
  const out = [];
  for(const d of DEPTS){
    d.items.forEach((it, idx)=>{
      const r = state[d.id][idx];
      const st = r.status || "todo";
      if(st === "todo" || st === "improve"){
        out.push({
          dept: d.name,
          deptId: d.id,
          item: it.item,
          status: st,
          owner: r.owner,
          date: r.date,
        });
      }
    });
  }
  // Prioridad: todo primero, luego improve; luego por fecha
  out.sort((a,b)=>{
    const pr = (x)=> x.status==="todo" ? 0 : 1;
    if(pr(a)!==pr(b)) return pr(a)-pr(b);
    const da = a.date || "9999-12-31";
    const db = b.date || "9999-12-31";
    if(da<db) return -1;
    if(da>db) return 1;
    return 0;
  });
  return out;
}

/* Export / Reset */
document.getElementById("btnExport").onclick = ()=>{
  const blob = new Blob([JSON.stringify({ createdAt: new Date().toISOString(), state }, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "advency_auditoria.json";
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById("btnReset").onclick = ()=>{
  if(!confirm("¬øSeguro que quieres resetear todo?")) return;
  state = makeEmptyState();
  saveState();
  renderDept();
};

function init(){
  renderTabs();
  renderDept();
  renderDashboard();
}
init();
</script>
</body>
</html>
